(function($){var passiveSupported=false;try{window.addEventListener("test",null,Object.defineProperty({},"passive",{get:function(){passiveSupported=true;}}));}catch(err){}
function getEntitiesList(classList,entityPrefix,tagPrefix){var tags=[];$.each(classList,function(index,item){if(item.startsWith(entityPrefix)){tags.push(tagPrefix+item);}});return tags;}
function getTagsList(classList,tagPrefix){return getEntitiesList(classList,'tag-',tagPrefix);}
function getCategoriesList(classList,tagPrefix){return getEntitiesList(classList,'category-',tagPrefix);}
function sendTagsVK(newTags){$.each(newTags,function(index,newTag){VK.Retargeting.Event(newTag);});}
function sendTagsFB(newTags){var event=newTags[0].substr(0,newTags[0].indexOf('-'));var tagsToSend=[];var categoriesToSend=[];$.each(newTags,function(index,newTag){if(newTag.indexOf('-tag-')!==-1){tagsToSend.push(newTag.replace(event+'-tag-',''));}else{categoriesToSend.push(newTag.replace(event+'-category-',''));}});fbq('trackCustom',event,{tags:tagsToSend,categories:categoriesToSend});}
function sendTags(newTags,checkPostsKey,postId){if(newTags.length>0){if(typeof OneSignal!=='undefined'){OneSignal.push(["getTags",function(tags){var tagsToSend={};if(checkPostsKey&&postId>0){var postIds=[];if(typeof tags[checkPostsKey]==='string'){var postIds=tags[checkPostsKey].split(',');if($.inArray(postId.toString(),postIds)!=-1)return;}
postIds.push(postId);tagsToSend[checkPostsKey]=postIds.join();}
$.each(newTags,function(index,newTag){if(newTag in tags){tagsToSend[newTag]=parseInt(tags[newTag])+1;}else{tagsToSend[newTag]=1;}});OneSignal.sendTags(tagsToSend,function(tagsSent){});}]);}
if(typeof VK!=='undefined'&&typeof VK.Retargeting!=='undefined'){sendTagsVK(newTags);}else{window.vkRetargetInit=function(){sendTagsVK(newTags);}}
if(typeof fbq==='function'){sendTagsFB(newTags);}else{window.fbRetargetInit=function(){sendTagsFB(newTags);}}}}
function sendPostEvent(postId,event){if(postId<1)return;let data={post_id:postId,event_type:event};fetch('https://rstat.tproger.ru/wh/post',{method:'POST',headers:{'Content-Type':'application/json;charset=utf-8'},body:JSON.stringify(data)});}
function getArticleTagsAndSend(tagPrefix,checkPostsKey){var articleElem=$('div#content > article.post');if(articleElem.length>0){var postId=parseInt(articleElem.attr('id').replace('post-',''));var classList=articleElem.attr('class').split(/\s+/);var viewTags=getTagsList(classList,tagPrefix);var viewCategories=getCategoriesList(classList,tagPrefix);sendTags(viewTags.concat(viewCategories),checkPostsKey,postId);sendPostEvent(postId,tagPrefix.substr(0,tagPrefix.length-1));}}
function checkArticleRead(){if(($('html').scrollTop()||$('body').scrollTop())+$(window).height()>articleEndElem.offset().top){window.removeEventListener('scroll',checkArticleRead);getArticleTagsAndSend('read-','posts-read');}}
function setArticleReadChecker(){window.addEventListener('scroll',checkArticleRead,passiveSupported?{passive:true}:false);checkArticleRead();}
getArticleTagsAndSend('view-');function sendArticleVisited(){getArticleTagsAndSend('visit-','posts-visited');}
setTimeout(sendArticleVisited,7*1000);var articleEndElem=$('#article-end-beacon');if(articleEndElem.length)setTimeout(setArticleReadChecker,21*1000);})(jQuery);